{% extends "base.html" %}

{% block title %}Search{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='vendor/css/flatpickr.min.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='vendor/css/nouislider.min.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/search.css') }}">
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='vendor/js/flatpickr.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/js/nouislider.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/search.js') }}" defer></script>
{% endblock %}

{% block content %}

<div class="title-container">
    <h1>Search AudiobookBay</h1>
</div>
<div class="search-container" id="search-container">
<form method="post" class="search-form" onsubmit="showLoadingSpinner()">
    <input type="text" name="query" placeholder="Enter book name" class="search-bar" value="{{ query }}" required>
    <button type="submit" class="search-button">
        <span class="button-text">Search</span>
        <div class="button-spinner" id="button-spinner" style="display: none;">
            <div class="spinner"></div>
        </div>
    </button>
</form>
</div>
<div class="message-scroller" id="message-scroller">
    <p id="scrolling-message"></p>
</div>

<div class="loading-spinner" id="loading-spinner">
    <div class="spinner"></div>
    <p>Searching...</p>
</div>

{% if error %}
  <p class="error-message">{{ error }}</p>
{% endif %}

{% if books %}
<div id="filter-container">
    <div class="filter-row">
        <div class="filter-controls">
            <select id="language-filter">
                <option value="">All Languages</option>
            </select>
            <select id="bitrate-filter">
                <option value="">All Bitrates</option>
            </select>
            <select id="format-filter">
                <option value="">All Formats</option>
            </select>
            <input type="text" id="date-range-filter" placeholder="Select Date Range">
        </div>
        <div class="filter-buttons">
            <button id="filter-button">Filter</button>
        </div>
    </div>
    <div class="filter-row">
        <div class="filter-controls">
            <div class="file-size-filter-wrapper">
                <label>File Size:</label>
                <div id="file-size-slider"></div>
            </div>
        </div>
        <div class="filter-buttons">
             <button id="clear-button">Clear</button>
        </div>
    </div>
</div>
{% endif %}

<table>
    <tbody id="results-table-body">
        {% for book in books %}
        <tr class="result-row"
            data-language="{{ book.language }}"
            data-bitrate="{{ book.bitrate }}"
            data-format="{{ book.format }}"
            data-file-size="{{ book.file_size }}"
            data-post-date="{{ book.post_date }}">
            <td><img src="{{ book.cover }}" alt="Cover Art" class="cover" width="100"></td>
            <td><p class="book-title">{{ book.title }}</p>
                <div class="property-results-container">
                    <span class="book-language">Language: {{ book.language }}</span>
                    <span class="book-bitrate">Bitrate: {{ book.bitrate }}</span>
                    <span class="book-format">Format: {{ book.format }}</span>
                    <span class="book-file_size">File Size: {{ book.file_size }}</span>
                    <span class="book-post_date">Posted: {{ book.post_date }}</span>
                </div>
            </td>
            <td>
                <button onclick="window.open('{{ book.link }}', '_blank')">Details</button>
                <button onclick="sendToQB('{{ book.link|escape }}', '{{ book.title|escape }}')">Download to Server</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% endblock %}